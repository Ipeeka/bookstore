<div class="book-list">
  <div class="header-container">
    <h1 style="width: 200px">BOOK LIST:</h1>

    <div class="booklist-container">
      <div class="search-bar">
        <p-iconField>
          <p-inputIcon styleClass="fas fa-search" [style.color]="'#3e97ff'" />
          <input
            type="text"
            pInputText
            placeholder="Search"
            [(ngModel)]="searchQuery"
            (input)="onSearch()"
          />
        </p-iconField>
      </div>

      <div class="filter-toggle-container" [class.show]="isFilterVisible">
        <button
          mat-mini-fab
          color="primary"
          matTooltip="Apply Filter"
          (click)="toggleFilter()"
          class="toggle-btn"
        >
          <i class="pi pi-filter me-2"></i>
        </button>
        <div class="filter-options">
          <div style="margin-bottom: 25px">
            <button (click)="toggleFilter()" class="close-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <div class="filter-item-container">
            <div class="filter-item">
              <label for="genre">Genre:</label>
              <select [(ngModel)]="selectedGenre" id="genre">
                <option value="all">All</option>
                <option value="fiction">Fiction</option>
                <option value="non-fiction">Non-Fiction</option>
                <option value="science">Science</option>
                <option value="fantasy">Fantasy</option>
              </select>
            </div>

            <div class="filter-item">
              <label for="availability">Availability:</label>
              <select [(ngModel)]="selectedAvailability" id="availability">
                <option value="all">All</option>
                <option value="true">Available</option>
                <option value="false">Out of Stock</option>
              </select>
            </div>
          </div>

          <div class="filter-item">
            <label for="price">Price Range:</label>
            <input
              type="range"
              id="price"
              [(ngModel)]="selectedPrice"
              min="100"
              max="1000"
              step="5"
            />
            <span>{{ selectedPrice }} $</span>
          </div>

          <div class="filter-actions">
            <button mat-button (click)="clearFilters()" class="clear-filter">
              Clear
            </button>
            <button mat-button (click)="applyFilter()" class="apply-btn">
              Apply
            </button>
          </div>
        </div>
      </div>

      <div class="add-book-btn">
        <button
          mat-mini-fab
          color="primary"
          matTooltip="Add Book"
          (click)="openAddBookDialog()"
          class="add-btn"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="body-container">
    <div class="toggle-container">
      <mat-button-toggle-group
        [(ngModel)]="viewMode"
        aria-label="View Mode"
        appearance="standard"
      >
        <mat-button-toggle value="table" class="square-toggle">
          <mat-icon>table_chart</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="grid" class="square-toggle">
          <mat-icon>grid_view</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <mat-card>
      <div *ngIf="viewMode === 'table'">
        <table
          mat-table
          [dataSource]="dataSource"
          multiTemplateDataRows
          class="mat-elevation-z8"
        >
          <ng-container matColumnDef="serialNo">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              SerialNo
            </th>
            <td mat-cell *matCellDef="let element; let rowIndex = dataIndex">
              {{ rowIndex + 1 }}.
            </td>
          </ng-container>

          <ng-container matColumnDef="title">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Title
            </th>
            <td mat-cell *matCellDef="let element">{{ element.title }}</td>
          </ng-container>

          <ng-container matColumnDef="author">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Author
            </th>
            <td mat-cell *matCellDef="let element">{{ element.author }}</td>
          </ng-container>

          <ng-container matColumnDef="publicationYear">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Year
            </th>
            <td mat-cell *matCellDef="let element">
              {{ element.publicationYear | date : "YYYY" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="price">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Price
            </th>
            <td mat-cell *matCellDef="let element">
              {{ element.price | currency }}
            </td>
          </ng-container>

          <ng-container matColumnDef="genre">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Genre
            </th>
            <td mat-cell *matCellDef="let element">{{ element.genre }}</td>
          </ng-container>

          <ng-container matColumnDef="availability">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              Availability
            </th>
            <td mat-cell *matCellDef="let element">
              <span
                class="status-badge"
                [ngStyle]="getStatusStyle(element.inventoryStatus)"
              >
                {{ getStatusLabel(element.inventoryStatus) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions" *ngIf="!isUser">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              class="head"
              *matHeaderCellDef
            >
              Actions
            </th>
            <td mat-cell *matCellDef="let book">
              <button
                mat-button
                class="edit-btn"
                (click)="openEditDialog(book)"
              >
                <i class="pi pi-pen-to-square"></i>
              </button>
              <button
                mat-button
                class="delete-btn"
                (click)="deleteBook(book._id)"
              >
                <i class="pi pi-trash"></i>
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="expand">
            <th
              mat-header-cell
              [ngStyle]="{ 'background-color': tableHeaderBgColor }"
              *matHeaderCellDef
            >
              &nbsp;
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                aria-label="expand row"
                (click)="
                  expandedElement =
                    expandedElement === element ? null : element;
                  $event.stopPropagation()
                "
              >
                <mat-icon *ngIf="expandedElement === element"
                  >keyboard_arrow_up</mat-icon
                >
                <mat-icon *ngIf="expandedElement !== element"
                  >keyboard_arrow_down</mat-icon
                >
              </button>
            </td>
          </ng-container>

          <ng-container matColumnDef="expandedDetail">
            <td
              mat-cell
              *matCellDef="let element"
              [attr.colspan]="columnsToDisplayWithExpand.length"
            >
              <div
                class="example-element-detail"
                [@detailExpand]="
                  element == expandedElement ? 'expanded' : 'collapsed'
                "
              >
                <div class="example-element-description">
                  <div
                    class="detail-actions"
                    style="
                      width: 100%;
                      display: flex;

                      align-items: center;
                    "
                  >
                    <div class="action-buttons" style="margin-bottom: 15px">
                      <section>
                        <mat-button-toggle-group
                          name="favoriteColor"
                          aria-label="Favorite Color"
                          [hideSingleSelectionIndicator]="
                            hideSingleSelectionIndicator()
                          "
                        >
                          <mat-button-toggle
                            value="red"
                            (change)="onLikeDislikeChange('like', element._id)"
                          >
                            <button
                              mat-icon-button
                              aria-label="Like"
                              matTooltip="Like"
                            >
                              <mat-icon>thumb_up</mat-icon>
                            </button>
                            <span>{{ element.likes }}</span>
                          </mat-button-toggle>
                          <mat-button-toggle
                            value="green"
                            (change)="
                              onLikeDislikeChange('dislike', element._id)
                            "
                          >
                            <button
                              mat-icon-button
                              aria-label="Dislike"
                              matTooltip="Dislike"
                            >
                              <mat-icon>thumb_down</mat-icon>
                            </button>
                            <span>{{ element.dislikes }}</span>
                          </mat-button-toggle>
                        </mat-button-toggle-group>
                      </section>

                      <button
                        mat-icon-button
                        aria-label="share"
                        matTooltip="share"
                      >
                        <i class="fas fa-share me-2" style="color: #888"></i>
                      </button>
                      <span>{{ element.share }}</span>

                      <button
                        mat-icon-button
                        aria-label="download"
                        matTooltip="download"
                      >
                        <i class="fas fa-download me-2" style="color: #888"></i>
                      </button>
                      <span>{{ element.download }}</span>

                      <button
                        mat-icon-button
                        aria-label="bookmark"
                        matTooltip="{{
                          element.bookmarked
                            ? 'Remove from Bookmarks'
                            : 'Add to Bookmarks'
                        }}"
                        (click)="
                          toggleBookmark(element._id, element.bookmarked)
                        "
                      >
                        <mat-icon>{{
                          element.bookmarked ? "bookmark" : "bookmark_border"
                        }}</mat-icon>
                      </button>

                      <!-- book-list.component.html -->
                      <button
                        mat-icon-button
                        aria-label="cart"
                        matTooltip="{{
                          element.cartAdded ? 'Remove from Cart' : 'Add to Cart'
                        }}"
                        (click)="toggleCart(element._id, element.cartAdded)"
                      >
                        <mat-icon>
                          {{
                            element.cartAdded
                              ? "remove_shopping_cart"
                              : "add_shopping_cart"
                          }}
                        </mat-icon>
                      </button>
                      <!-- <span>{{ element.download }}</span> -->

                      <div
                        class="comment-toggle-container"
                        [class.show]="isCommentSectionVisible"
                      >
                        <button
                          mat-icon-button
                          aria-label="Comments"
                          (click)="toggleCommentSection(element._id)"
                          matTooltip="Comments"
                        >
                          <i
                            class="far fa-comment-dots me-2"
                            style="color: #888"
                          ></i>
                        </button>
                      </div>
                      <button
                        mat-icon-button
                        aria-label="Report"
                        matTooltip="Report"
                      >
                        <i class="pi pi-flag me-2" style="color: #888"></i>
                      </button>
                      <span></span>
                      <button
                        mat-icon-button
                        aria-label="Report"
                        matTooltip="Report"
                      >
                        <i
                          class="pi pi-ellipsis-v me-2"
                          style="color: #888"
                        ></i>
                      </button>
                      <span></span>
                    </div>
                  </div>

                  <div class="comment-options">
                    <mat-card
                      *ngIf="isCommentSectionVisible"
                      class="row d-flex justify-content-center"
                    >
                      <div class="col-md-12 col-lg-6">
                        <div
                          class="card shadow-lg border-0"
                          style="background-color: #ffffff; border-radius: 15px"
                        >
                          <div class="card-body p-4">
                            <div class="form-outline">
                              <textarea
                                id="addANote"
                                class="form-control"
                                placeholder="Type your comment..."
                                rows="4"
                                style="
                                  border-radius: 15px;
                                  border: 1px solid #ccc;
                                  padding-left: 15px;
                                  font-size: 16px;
                                  resize: none;
                                  width: 100%;
                                "
                                [(ngModel)]="addedComments"
                              ></textarea>
                              <p>pls . be respectful to others</p>
                              
                              <p-button  icon="pi pi-send" iconPos="right" styleClass="send-button"  (click)="saveBookDetails(element._id)"></p-button>

                            </div>

                            <div
                              class="comments-container"
                              style="
                                max-height: 180px;
                                overflow-y: auto;
                                padding-right: 10px;
                                width: 1000px;
                              "
                            >
                              <div
                                *ngFor="let comment of comments"
                                class="comment-card mb-4"
                                style="
                                  background-color: #f9f9f9;
                                  border-radius: 10px;
                                  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                                "
                              >
                                <div class="card-body p-3">
                                  <div class="d-flex flex-column mb-2">
                                    <div
                                      class="d-flex flex-row align-items-center mb-2"
                                    >
                                      <img
                                        src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(4).webp"
                                        alt="avatar"
                                        width="40"
                                        height="40"
                                        style="border-radius: 50%"
                                      />
                                      <p
                                        class="small mb-0 ms-2"
                                        style="font-weight: bold; color: #333"
                                      >
                                        {{ comment.UserName }}
                                      </p>
                                    </div>

                                    <div>
                                      <p style="font-size: 14px; color: #555">
                                        {{ comment.Comments }}
                                      </p>
                                    </div>

                                    <div class="comment-actions">
                                      <a
                                        href="#!"
                                        class="d-flex align-items-center me-3"
                                        style="
                                          text-decoration: none;
                                          color: #888;
                                        "
                                      >
                                        <i
                                          class="far fa-thumbs-up me-2"
                                          style="color: #888"
                                        ></i>
                                        <p class="mb-0" style="font-size: 14px">
                                          Like
                                        </p>
                                      </a>

                                      <a
                                        href="#!"
                                        class="d-flex align-items-center me-3"
                                        style="
                                          text-decoration: none;
                                          color: #888;
                                        "
                                      >
                                        <i
                                          class="fa fa-reply me-2"
                                          style="color: #888"
                                        ></i>
                                        <p class="mb-0" style="font-size: 14px">
                                          Reply
                                        </p>
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </mat-card>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
          <tr
            mat-row
            *matRowDef="let element; columns: columnsToDisplayWithExpand"
            class="example-element-row"
            [class.example-expanded-row]="expandedElement === element"
            (click)="
              expandedElement = expandedElement === element ? null : element
            "
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="example-detail-row"
          ></tr>
        </table>
      </div>

      <div *ngIf="viewMode === 'grid'" class="grid-container">
        <mat-card *ngFor="let book of dataSource.data" class="book-card">
          <mat-card-header>
            <mat-card-title>{{ book.title }}</mat-card-title>
            <mat-card-subtitle>{{ book.author }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p><strong>Genre:</strong> {{ book.genre }}</p>
            <!-- <p><strong>Year:</strong> {{ book.publicationYear | date : "YYYY" }}</p> -->
            <p><strong>Price:</strong> {{ book.price | currency }}</p>
            <!-- <p>
            <span class="status-badge" [ngStyle]="getStatusStyle(book.inventoryStatus)">
              {{ getStatusLabel(book.inventoryStatus) }}
            </span>
          </p> -->
          </mat-card-content>
        </mat-card>
      </div>
      <div *ngIf="dataSource.data.length === 0" class="no-data-message">
        No data found , try something else .
      </div>
    </mat-card>
  </div>

  <div class="mt-2 mb-4 footer-container">
    <mat-paginator
      [length]="dataSource.data.length"
      [pageSize]="5"
      [pageSizeOptions]="[5, 10]"
      showFirstLastButtons
    ></mat-paginator>
  </div>

  <p-dialog
    [(visible)]="displayDialog"
    [style]="{ width: '600px', height: '700px' }"
    [header]="isEditMode ? 'Edit Book' : 'Add Book'"
    [modal]="true"
    [closable]="true"
    styleClass="p-fluid"
    (onHide)="onDialogHide()"
    [resizable]="false"
  >
    @if(isEditMode){
      <edit-book
        [data]="selectedBook"
        (saveBook)="onBookUpdate($event)"
      ></edit-book>
    }
    @else {
      <add-book (saveBook)="onBookSaved($event)"></add-book>
    }
<!-- 
    <ng-template #addBookTemplate>
      <add-book (saveBook)="onBookSaved($event)"></add-book>
    </ng-template> -->
  </p-dialog>

  <div class="card flex justify-center">
    <p-toast></p-toast>

    <p-confirmDialog></p-confirmDialog>
  </div>
</div>
